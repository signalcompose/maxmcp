#!/bin/bash
# MaxMCP Pre-Commit Hook
# Runs format and lint checks before committing

set -e

echo "ðŸ” Running pre-commit checks..."

# Get list of staged C++ files
STAGED_CPP_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(cpp|h)$' || true)

# Get list of staged Node.js files in bridge
STAGED_JS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '^package/MaxMCP/support/bridge/.*\.js$' || true)

# C++ Format Check
if [ -n "$STAGED_CPP_FILES" ]; then
    echo "ðŸ“ Checking C++ formatting..."
    if command -v clang-format >/dev/null 2>&1; then
        echo "$STAGED_CPP_FILES" | xargs clang-format --dry-run --Werror
        if [ $? -ne 0 ]; then
            echo "âŒ C++ formatting check failed!"
            echo "ðŸ’¡ Run: find src -name '*.cpp' -o -name '*.h' | xargs clang-format -i"
            exit 1
        fi
        echo "âœ… C++ formatting OK"
    else
        echo "âš ï¸  clang-format not found, skipping C++ format check"
    fi
fi

# Node.js Lint Check
if [ -n "$STAGED_JS_FILES" ]; then
    echo "ðŸ“ Checking Node.js code..."
    cd package/MaxMCP/support/bridge

    # Check if node_modules exists
    if [ ! -d "node_modules" ]; then
        echo "âš ï¸  node_modules not found, run: npm install"
        exit 1
    fi

    # Run ESLint
    npm run lint --silent
    if [ $? -ne 0 ]; then
        echo "âŒ ESLint check failed!"
        echo "ðŸ’¡ Run: npm run lint:fix"
        exit 1
    fi

    # Run Prettier check
    npm run format:check --silent
    if [ $? -ne 0 ]; then
        echo "âŒ Prettier check failed!"
        echo "ðŸ’¡ Run: npm run format"
        exit 1
    fi

    cd - > /dev/null
    echo "âœ… Node.js linting OK"
fi

# C++ Tests (optional - can be slow)
# Uncomment if you want to run tests on every commit
# if [ -n "$STAGED_CPP_FILES" ]; then
#     echo "ðŸ§ª Running C++ tests..."
#     if [ -d "build" ]; then
#         cd build && ctest --output-on-failure && cd ..
#     fi
# fi

echo "âœ… All pre-commit checks passed!"
exit 0
